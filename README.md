# üìã PinokIO - –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### üîë –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ü§ñ **–ò–ò-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è** —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
- üìä **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π** (–∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è + –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è)
- ‚è∞ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è** –æ –≤–∏—Å—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- üîó **–£–º–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ** –æ—Ç–≤–µ—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
- üìà **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–∏—à–∏–Ω—ã** –≤ —á–∞—Ç–∞—Ö
- ‚öôÔ∏è **–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```text
pinok_io/
‚îú‚îÄ‚îÄ üìÑ app.py                    # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îú‚îÄ‚îÄ ‚öôÔ∏è config.py                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îú‚îÄ‚îÄ üê≥ Dockerfile               # Docker –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ üê≥ docker-compose.yml       # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ üìã requirements.txt          # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ üìñ functional_schema.md      # –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ (—É—Å—Ç–∞—Ä–µ–≤—à–∞—è)
‚îú‚îÄ‚îÄ üìñ README.md                # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ üìÅ configs/                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ config_chats.yaml       # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ config_redis.yaml       # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Redis
‚îÇ   ‚îî‚îÄ‚îÄ prompts.yaml            # –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –ò–ò
‚îî‚îÄ‚îÄ üìÅ src/                     # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
    ‚îú‚îÄ‚îÄ üß† llm.py              # –ò–ò –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    ‚îú‚îÄ‚îÄ üîÑ producer.py         # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    ‚îú‚îÄ‚îÄ üóÑÔ∏è redis_client.py     # Redis –∫–ª–∏–µ–Ω—Ç
    ‚îî‚îÄ‚îÄ üìÅ utils/              # –£—Ç–∏–ª–∏—Ç—ã
        ‚îú‚îÄ‚îÄ env_utils.py       # –†–∞–±–æ—Ç–∞ —Å .env
        ‚îú‚îÄ‚îÄ httpx_utils.py     # HTTP –∫–ª–∏–µ–Ω—Ç
        ‚îú‚îÄ‚îÄ loguru_utils.py    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        ‚îú‚îÄ‚îÄ schemas_kafka.py   # Pydantic —Å—Ö–µ–º—ã
        ‚îî‚îÄ‚îÄ time_manager.py    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–µ–º
```

### üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. **FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** (`app.py`)

- **–≠–Ω–¥–ø–æ–∏–Ω—Ç**: `POST /process_request`
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: Bearer token
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: Pydantic —Å—Ö–µ–º—ã
- **Lifecycle**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º producer'–∞

#### 2. **Producer** (`src/producer.py`)

- **–û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞** –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ò–ò –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è** —Ç–µ–∫—Å—Ç–∞
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—è–º–∏** Redis
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–∞–π–º–∞—É—Ç–æ–≤** –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

#### 3. **Redis Client** (`src/redis_client.py`)

- **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π**:
  - –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è: `stream:chat:{chat_id}`
  - –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è: `stream:chat:{chat_id}:final`
- **–ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π** –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫** –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π
- **–í–æ—Ä–∫–µ—Ä—ã** –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

#### 4. **LLM** (`src/llm.py`)

- **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è** —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç—Ä–µ–±—É–µ—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ –Ω–µ—Ç)
- **–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ** –æ—Ç–≤–µ—Ç–æ–≤ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
- **OpenAI API** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+
- Redis 6.0+
- Docker & Docker Compose (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞

#### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
cd micro_services/pinok_io

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
cp env.sample .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
python app.py
```

#### Docker

```bash
# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose
docker-compose up --build

# –ò–ª–∏ —Ç–æ–ª—å–∫–æ —Å–±–æ—Ä–∫–∞
docker build -t pinok_io .
```

### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`.env`)

```bash
# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
BEARER_TOKEN=your_secret_token

# –ë–æ—Ç
DEFAULT_USER_ID_BOT=bot_user_id

# Kafka
KAFKA_SENDER_URL=http://kafka_sender:PORT

# LLM
LLM_URL=https://LLM:PORT/v1
LLM_API_KEY=your_openai_api_key
LLM_MODEL=<YOUR LLM MODEL>

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
CHECK_INTERVAL=5
```

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–∞—Ç–æ–≤ (`configs/.config_chats.yaml`)

```yaml
"00000000-00000000-00000000-00000000-00000000": # –≤—Ö–æ–¥—è—â–∏–π —á–∞—Ç
  input_chat_name: "G1"
  pinger:
    output_chat_id: "00000000-00000000-00000000-00000000-00000000" # —á–∞—Ç –≤ –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
    enabled: true # —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    whitelist: ["@telegram_acc"] # —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ pp
    bot_enabled: true # —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∫–∞–∫ pp (False –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
    start_time: "07:00" #UTC - –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
    end_time: "19:00"   #UTC - –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã
    days: [mon, tue, wed, thu, fri] # —Ä–∞–±–æ—á–∏–µ –¥–Ω–∏
    redis_buffer_window: 20
    message_timeout: 40
  silencer:
    output_chat_id: "00000000-00000000-00000000-00000000-00000000" # —á–∞—Ç –≤ –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
    enabled: true # –≤–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–∏—à–∏–Ω—ã
    silence_timeout: 90 
```

---

## üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Message       ‚îÇ    ‚îÇ   PinokIO       ‚îÇ    ‚îÇ   Redis         ‚îÇ
‚îÇ   Service       ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Microservice ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Database      ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ –í—Ö–æ–¥—è—â–∏–µ      ‚îÇ    ‚îÇ ‚Ä¢ FastAPI       ‚îÇ    ‚îÇ ‚Ä¢ –°—Ç—Ä–∏–º—ã        ‚îÇ
‚îÇ   —Å–æ–æ–±—â–µ–Ω–∏—è     ‚îÇ    ‚îÇ ‚Ä¢ Producer      ‚îÇ    ‚îÇ ‚Ä¢ –•–µ—à–∏          ‚îÇ
‚îÇ ‚Ä¢ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è   ‚îÇ    ‚îÇ ‚Ä¢ LLM Client    ‚îÇ    ‚îÇ ‚Ä¢ ZSets         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ   Kafka Sender  ‚îÇ
                       ‚îÇ                 ‚îÇ
                       ‚îÇ ‚Ä¢ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è   ‚îÇ
                       ‚îÇ ‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è   ‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç MS                                    ‚îÇ
‚îÇ 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (Bearer token)                          ‚îÇ
‚îÇ 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö                                    ‚îÇ
‚îÇ 4. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–≤—ã—Ö–æ–¥–Ω–æ–π —á–∞—Ç, –≤—Ä–µ–º—è, –∏–∑–º–µ–Ω–µ–Ω–∏—è)    ‚îÇ
‚îÇ 5. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (MERCHANT/PP)                  ‚îÇ
‚îÇ 6. –ò–ò –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–¥–ª—è MERCHANT)                              ‚îÇ
‚îÇ 7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ Redis –æ—á–µ—Ä–µ–¥—å                                   ‚îÇ
‚îÇ 8. –ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –°–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π Redis                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –æ—á–µ—Ä–µ–¥—å (SHORT)                                   ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ stream:chat:{chat_id}                                       ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ –û–∫–Ω–æ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏: 20 —Å–µ–∫—É–Ω–¥                                   ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–Ω–æ—Å –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –æ—á–µ—Ä–µ–¥—å               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –æ—á–µ—Ä–µ–¥—å (LONG)                                     ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ stream:chat:{chat_id}:final                                 ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ –§–∏–Ω–∞–ª—å–Ω—ã–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è                          ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç PP                                       ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–∞–π–º–∞—É—Ç–æ–≤                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### üì• –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

```mermaid
graph TD
    A[–í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ] --> B{–í—ã—Ö–æ–¥–Ω–æ–π —á–∞—Ç?}
    B -->|–î–∞| C[–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å]
    B -->|–ù–µ—Ç| D{–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã?}
    D -->|–ù–µ—Ç| E[–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å]
    D -->|–î–∞| F{–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è?}
    F -->|–î–∞| G[–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å]
    F -->|–ù–µ—Ç| H[–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
    
    H --> I{–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è}
    I -->|MERCHANT| J[–ò–ò –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è]
    I -->|PP| K[–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å]
    
    J --> L{–¢—Ä–µ–±—É–µ—Ç –æ—Ç–≤–µ—Ç–∞?}
    L -->|–î–∞| M[–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å]
    L -->|–ù–µ—Ç| N[–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å]
    
    K --> O[–°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å –≤–æ–ø—Ä–æ—Å–æ–º]
    M --> P[–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä]
    O --> Q[–£–¥–∞–ª–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]
```


## –ò–ò –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π

**–¶–µ–ª—å**: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç—Ä–µ–±—É–µ—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏**:

- 10+ —Å–ª–æ–≤
- –í–æ–ø—Ä–æ—Å—ã, –∂–∞–ª–æ–±—ã, —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –°—Å—ã–ª–∫–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—ã, email
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏

**–í—ã—Ö–æ–¥**: `{class: 0|1, confidence: 0.0-1.0}`

#### 2. –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤

**–¶–µ–ª—å**: –°–≤—è–∑–∞—Ç—å –æ—Ç–≤–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å –≤–æ–ø—Ä–æ—Å–æ–º –∫–ª–∏–µ–Ω—Ç–∞

**–ö—Ä–∏—Ç–µ—Ä–∏–∏**:

- –Ø–∑—ã–∫–æ–≤–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (RU/EN)
- –õ–µ–∫—Å–∏—á–µ—Å–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
- –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ
- –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–∏–∑–æ—Å—Ç—å

**–í—ã—Ö–æ–¥**: `{matched_message_id: int|null}`

### ‚è∞ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

#### –°–∏—Å—Ç–µ–º–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤

```text
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤
‚îú‚îÄ‚îÄ –í–æ–∑—Ä–∞—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π > —Ç–∞–π–º–∞—É—Ç?
‚îÇ   ‚îú‚îÄ‚îÄ –î–ê ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Kafka
‚îÇ   ‚îî‚îÄ‚îÄ –ù–ï–¢ ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
‚îî‚îÄ‚îÄ –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
```

#### –ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–∏—à–∏–Ω—ã –≤ —á–∞—Ç–∞—Ö

```text
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–∏—à–∏–Ω—ã –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
‚îú‚îÄ‚îÄ LONG –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞?
‚îÇ   ‚îú‚îÄ‚îÄ –î–ê ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ø—Ä–æ—à–ª–æ > SILENCE_TIMEOUT ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–∏—à–∏–Ω–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –ò–Ω–∞—á–µ ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
‚îÇ   ‚îî‚îÄ‚îÄ –ù–ï–¢ ‚Üí –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —á–∞—Ç–∞
```

---

## üîå API Reference

### POST `/process_request`

–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Message Service.

#### –ó–∞–ø—Ä–æ—Å

**Headers**:

```text
Authorization: Bearer <token>
Content-Type: application/json
```

**Body** (`IncomingFromMsRequest`):

```json
{
  "messages__id": "uuid",
  "messages__chat_id": "chat_id",
  "messages__user_id": "user_id",
  "messages__username": "@username",
  "messages__date": "2025-01-15 10:30:00.000000",
  "text_histories__text": "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
  "text_histories__id": "text_id",
  "messages__parent_message_id": "parent_id",
  "text_histories__change_id": "change_id"
}
```

#### –û—Ç–≤–µ—Ç

**–£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**:

```json
{
  "status": "processed",
  "reason": "message_added_to_queue"
}
```

**–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ**:

```json
{
  "status": "ignored",
  "reason": "output_chat|change_message|bot_disabled|no_response_needed"
}
```

**–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞**:

```json
{
  "status": "blocked",
  "reason": "time_blocked"
}
```

---

## üóÑÔ∏è Redis —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –ö–ª—é—á–∏

```yaml
# –°—Ç—Ä–∏–º—ã
stream:chat:{chat_id}              # –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –æ—á–µ—Ä–µ–¥—å
stream:chat:{chat_id}:final        # –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –æ—á–µ—Ä–µ–¥—å

# –•–µ—à–∏
agg:{chat_id}                      # –ë—É—Ñ–µ—Ä —Ç–µ–∫—É—â–µ–π —Å–µ—Ä–∏–∏
conf:chat:{chat_id}               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–∞—Ç–∞
metrics:chat:{chat_id}            # –ú–µ—Ç—Ä–∏–∫–∏ —á–∞—Ç–∞

# –°–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞
sched:agg                         # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–µ–¥–ª–∞–π–Ω–æ–≤
```

### –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

#### –°–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å—Ç—Ä–∏–º–µ

```json
{
  "user_id": "user_uuid",
  "messages_id": "message_uuid", 
  "username": "username",
  "user_type": "merchant|pp",
  "text": "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
  "timestamp": "1640995200.123",
  "type": "short|long"
}
```

#### –ê–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Ä–∏—è (agg:{chat_id})

```json
{
  "user_id": "user_uuid",
  "messages_id": "last_message_uuid",
  "username": "username", 
  "user_type": "merchant|pp",
  "text": "–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç",
  "start_ts": "1640995200.123",
  "last_ts": "1640995220.456",
  "count": "3"
}
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞](functional_schema.md) - –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis](configs/config_redis.yaml)
- [–ü—Ä–æ–º–ø—Ç—ã –ò–ò](configs/prompts.yaml)

---